FROM node:22-slim

RUN npm install -g pnpm

WORKDIR /app

COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY packages/web/package.json packages/web/

RUN pnpm install --frozen-lockfile

# Source files are bind-mounted over this in docker-compose.dev.yml,
# but copying them here ensures the image also works standalone.
COPY packages/web packages/web

RUN mkdir -p /app/secrets

EXPOSE 7777

ENV PORT=7777

WORKDIR /app/packages/web

CMD ["sh", "-c", "pnpm db:migrate && pnpm dev"]
