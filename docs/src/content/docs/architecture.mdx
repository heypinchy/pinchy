---
title: Architecture
description: How Pinchy wraps OpenClaw, the request flow, and the tech stack.
---

## Overview

Pinchy is **not a fork** of OpenClaw. It's a governance layer on top of it. OpenClaw handles agent execution, tool use, and model communication. Pinchy adds authentication, provider management, and (soon) permissions, audit trails, and team management.

```
┌─────────────────────────────────────────────┐
│                  Browser                     │
│         (Next.js React Frontend)             │
└──────────┬──────────────────┬───────────────┘
           │ HTTPS            │ WebSocket
           │ (pages, API)     │ (/api/ws)
           ▼                  ▼
┌─────────────────────────────────────────────┐
│              Pinchy (Node.js)                │
│                                             │
│  ┌──────────┐  ┌──────────┐  ┌───────────┐ │
│  │ Next.js  │  │    WS    │  │   Auth    │ │
│  │  Pages   │  │  Bridge  │  │  (Auth.js)│ │
│  └──────────┘  └────┬─────┘  └───────────┘ │
│                     │                       │
│  ┌──────────────────┴───────────────────┐   │
│  │          Drizzle ORM                 │   │
│  └──────────────────┬───────────────────┘   │
│                     │                       │
└─────────────────────┼───────────────────────┘
                      │
          ┌───────────┼───────────┐
          ▼                       ▼
┌──────────────────┐   ┌──────────────────┐
│   PostgreSQL 16  │   │    OpenClaw      │
│                  │   │    Gateway       │
│  users, agents,  │   │   (port 18789)  │
│  settings, keys  │   │                 │
└──────────────────┘   └──────────────────┘
```

## Request flow

When a user sends a message, it flows through three layers:

1. **Browser** → connects via WebSocket to `/api/ws` on Pinchy
2. **Pinchy** → receives the message, generates a message ID, and forwards it to OpenClaw Gateway via a second WebSocket connection
3. **OpenClaw** → processes the message through the configured model and streams the response back
4. **Pinchy** → attaches the message ID and forwards each chunk to the browser
5. **Browser** → renders the streaming response in real time

Each browser connection gets its own dedicated OpenClaw connection. Pinchy acts as a bridge — it never interprets or modifies the AI response content.

## Authentication

Pinchy uses [Auth.js v5](https://authjs.dev/) with a credentials provider:

- Passwords are hashed with **bcrypt** before storage
- Sessions use **JWT** strategy (stateless, no server-side session store)
- JWTs carry the user's **role** (`admin` or `user`) for authorization checks
- The first user created via the setup wizard becomes the admin
- All app routes require authentication — unauthenticated requests redirect to `/login`

### Roles

Pinchy has two roles:

- **Admin** — can manage agents, users, invites, and settings
- **User** — can chat with agents and update their own profile

### Invite system

Admins invite new users by generating an invite token:

1. Admin creates an invite for an email address via **Settings → Users**
2. Pinchy generates a random token, stores its **SHA-256 hash** in the database, and returns the plaintext token as a one-time invite link
3. The invite recipient opens the link, sets their name and password, and their account is created
4. A personal **Smithers** agent is automatically created for the new user
5. Invite tokens expire after **7 days** and are single-use

## Permission layer

Pinchy enforces agent permissions through a defense-in-depth approach. When an agent is created from a template like **Knowledge Base**, Pinchy:

1. **Denies native tools** — tells OpenClaw to block the agent's access to file system, runtime, and web tool groups using OpenClaw's `tools.deny` policy
2. **Installs scoped alternatives** — the `pinchy-files` plugin provides `pinchy_ls` and `pinchy_read` tools that only access directories the admin explicitly allowed
3. **Validates paths at runtime** — every file access request is checked against the agent's allowed directories, with symlink resolution to prevent escapes

All agent-accessible files live under `/data/` in the container, mounted via Docker volumes. This means even if all software layers failed, the agent can only see files that were explicitly mounted.

For the full details, see [Agent Permissions](/concepts/agent-permissions/).

## Database

PostgreSQL 16, accessed via [Drizzle ORM](https://orm.drizzle.team/). The schema includes:

- **Auth tables** — `user`, `account`, `session`, `verificationToken` (managed by Auth.js adapter)
- **`agents`** — Agent configuration (name, model, system prompt, owner)
- **`invites`** — Invite tokens (SHA-256 hashed token, email, expiry, status)
- **`settings`** — Key-value store for app configuration (provider keys, onboarding state)

Migrations are generated with `drizzle-kit generate` and applied automatically on container startup via `drizzle-kit migrate`.

## Encryption

Provider API keys are encrypted at rest using **AES-256-GCM**:

- A 256-bit encryption key is either provided via the `ENCRYPTION_KEY` environment variable or auto-generated and persisted in the `pinchy-data` Docker volume
- Each encrypted value stores the IV, auth tag, and ciphertext together
- Decryption happens on-demand when Pinchy writes the OpenClaw configuration file

## OpenClaw integration

OpenClaw runs as a separate Docker container. Pinchy communicates with it exclusively via WebSocket on port 18789. The browser never connects to OpenClaw directly.

When a provider API key is saved in Pinchy, it writes the decrypted key to a shared Docker volume (`openclaw-config`). An inotify-based wrapper script inside the OpenClaw container detects the config change and restarts the gateway automatically.

## Tech stack

| Layer | Technology |
|-------|-----------|
| Frontend | Next.js 16, React 19, Tailwind CSS v4, shadcn/ui |
| Chat UI | assistant-ui (React) |
| Auth | Auth.js v5 (credentials provider, JWT sessions) |
| Database | PostgreSQL 16, Drizzle ORM |
| Agent runtime | OpenClaw Gateway (WebSocket) |
| Encryption | AES-256-GCM (Node.js crypto) |
| Testing | Vitest, React Testing Library |
| CI/CD | GitHub Actions, ESLint, Prettier |
| Deployment | Docker Compose |
| License | AGPL-3.0 |
